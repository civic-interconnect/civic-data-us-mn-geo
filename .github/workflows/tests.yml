# .github/workflows/tests.yml
# Automated testing for Minnesota precinct data adapter
# - On push/PR: validate manifest + run unit tests
# - On schedule: run live upstream health check and open issue if it fails

name: Validate MN Precinct Data

on:
  push:
    branches: [main, develop]
    paths:
      - 'js/**'
      - 'manifest.json'
      - 'api/v1.0.0/catalog.json'
      - 'schemas/**'
      - '.github/workflows/tests.yml'
  pull_request:
    branches: [main]
    paths:
      - 'js/**'
      - 'manifest.json'
      - 'api/v1.0.0/catalog.json'
      - 'schemas/**'

  schedule:
    # Run on the 1st of every month at 00:00 UTC
    - cron: '0 0 1 * *'

  workflow_dispatch: {}

jobs:
  validate-and-unit-tests:
    name: Validate manifest and run unit tests
    runs-on: ubuntu-latest
    steps:
      - name: 1) Check out repository
        uses: actions/checkout@v5

      - name: 2) Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"

      - name: 3) Install dependencies
        run: npm install

      - name: 4) Validate catalog and manifest (if you have these scripts)
        run: |
          if npm run -s validate:catalog 2>/dev/null; then
            echo "validate:catalog script found and executed."
          else
            echo "No validate:catalog script, skipping."
          fi

      - name: 5) Run unit tests (adapter / catalog_adapter / transform)
        run: |
          echo "Running unit tests..."
          # Assumes package.json has: "test": "node --test js/*.test.js"
          npm test

  live-upstream-check:
    name: Live upstream statewide check
    runs-on: ubuntu-latest
    # Only run on schedule or manual dispatch, not on every push
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - name: 1) Check out repository
        uses: actions/checkout@v5

      - name: 2) Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"

      - name: 3) Install dependencies
        run: npm install

      - name: 4) Run live statewide test
        run: |
          echo "Running live statewide precincts health check..."
          npx node --test js/live_precincts.test.js

  create-issue-on-failure:
    name: Create Issue on data availability failure
    runs-on: ubuntu-latest
    needs: [live-upstream-check]
    if: failure() && github.event_name == 'schedule'
    steps:
      - name: Create issue
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `MN Precinct Data Availability Alert - ${date}`,
              body: |
              ```## Minnesota Precinct Data Availability Issue
              The monthly live upstream health check has failed. This likely means:
                - The statewide precincts URL in `manifest.json` is unavailable, OR
                - The Minnesota Secretary of State changed the file format / location, OR
                - Network/proxy issues are preventing access.
                - Please investigate the issue and update the data adapter as necessary.
              ```